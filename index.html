<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Armor Vision ‚Äî Nutrition v1.5</title>
<link rel="manifest" href="./manifest.json">
<style>
:root{
  --bg:#0c0f16; --fg:#dfe5ee; --muted:#9aa6b2;
  --panel:#111623; --panel2:#0f1420; --border:#263043;
  --accent:#ff7a18; --shadow:0 6px 24px rgba(0,0,0,.45);
  --positive:#3ecf8e; --warn:#ffcf5a; --danger:#ff6b6b;
  --nav-h:68px; --card-radius:14px; --chip-bg:rgba(255,255,255,.06);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial;
  padding-bottom:calc(var(--nav-h) + env(safe-area-inset-bottom,12px));}
a,.link{color:var(--accent);text-decoration:none;cursor:pointer}
.accent{color:var(--accent);font-weight:600}
.muted{color:var(--muted)} .hidden{display:none!important} .right{margin-left:auto}
h1,h2,h3{margin:8px 0} h2{font-size:20px} h3{font-size:16px}
main{max-width:980px;margin:0 auto;padding:12px;padding-bottom:calc(var(--nav-h) + 20px);}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--card-radius);padding:12px;box-shadow:var(--shadow)}
.grid{display:grid;gap:12px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:1fr 1fr 1fr}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}
@media (max-width:900px){.grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px}
.kpi b{font-size:20px}
.table{width:100%;border-collapse:collapse;margin-top:6px}
.table td{border-bottom:1px dashed var(--border);padding:6px 4px;vertical-align:top}
.table tr:last-child td{border-bottom:none}
input,select,textarea{width:100%;background:var(--panel2);color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
input[type="checkbox"]{width:auto}
.seg{display:flex;gap:6px;flex-wrap:wrap}
.chip{background:var(--chip-bg);border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer}
.chip.active{background:rgba(255,255,255,.14);border-color:var(--accent)}
.btn{background:var(--chip-bg);color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;cursor:pointer}
.btn.small{padding:7px 10px;font-size:13px}
.btn.primary{background:linear-gradient(180deg,var(--accent),#ff5e00);color:#111;border-color:#000;font-weight:600}
.btn.ghost{background:transparent;border:none;padding:6px}
.btn:active{transform:translateY(1px)}
.badge{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:8px;margin-left:6px;color:var(--muted)}

/* Ent√™te */
header .topbar{max-width:980px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;justify-content:space-between}
.brand{display:flex;align-items:center;gap:12px}
.brand .ring{width:26px;height:26px;border:3px solid var(--accent);border-radius:50%;box-shadow:0 0 0 3px rgba(255,122,24,.2)}

/* Navbar (fixe en bas) */
nav.bottom{
  position:fixed;bottom:calc(env(safe-area-inset-bottom,8px) + 8px);left:50%;transform:translateX(-50%);
  width:calc(100% - 16px);max-width:980px;display:grid;grid-template-columns:repeat(5,1fr);gap:8px;
  background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:8px;box-shadow:var(--shadow);z-index:9999}
nav.bottom .btn{font-size:13px;padding:10px;width:100%}
nav.bottom .btn.icon-only{font-size:18px;padding:10px 8px}
nav.bottom .active{background:rgba(255,255,255,.14);border-color:var(--accent);box-shadow:inset 0 2px 0 rgba(0,0,0,.2)}
.end-spacer{height:calc(var(--nav-h) + 16px)}

/* Plan header sticky (titre + Date cible) */
.plan-title{display:flex;align-items:center;gap:8px;position:sticky;top:8px;z-index:55;background:var(--bg);padding:6px 0}
.plan-actions{margin-left:auto;display:flex;align-items:center;gap:2px}
.plan-controls{position:sticky;top:48px;z-index:54;background:var(--bg)}

/* Pr√©f√©rences/Restrictions */
.pref-grid label{display:flex;align-items:center;gap:8px;padding:6px 4px}
.pref-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px}
@media (max-width:600px){.pref-grid{grid-template-columns:1fr}}

/* Modals */
.modal{position:fixed;inset:0;display:none;place-items:center;z-index:80}
.modal.show{display:grid}
.modal .sheet{background:var(--panel);border:1px solid var(--border);border-radius:14px;max-width:720px;width:calc(100% - 24px);padding:12px;box-shadow:var(--shadow);position:relative;z-index:2}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);z-index:1}
.modal .sheet h3{margin-top:0}
.close-x{position:absolute;top:8px;right:10px;cursor:pointer}

/* Suivi / IMC */
.controls-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.controls-row .btn{flex:0 0 auto}
#dash .curve-controls{display:none!important}

/* Th√®mes & modes + palette femme */
.light{--bg:#f6f8fb;--fg:#10131a;--muted:#5d6b79;--panel:#fff;--panel2:#f5f7fb;--border:#dde3ef;--shadow:0 10px 30px rgba(0,0,0,.06)}
.theme-jarvis{--accent:#27a2ff}.theme-xvision{--accent:#ff7a18}.theme-shield{--accent:#35e27a}
.female.theme-jarvis{--accent:#6cbfff}.female.theme-xvision{--accent:#ff9a45}.female.theme-shield{--accent:#7ee8a6}

/* Impression */
@media print{
  nav.bottom, .plan-actions, .btn, .seg, .controls-row, .end-spacer{display:none!important}
  body{padding:0} main{padding:0;max-width:100%}
}

/* Swipe navigation */
html, body { touch-action: pan-y; }
</style>
</head>
<body class="theme-xvision">
<header>
  <div class="topbar">
    <div class="brand">
      <div class="ring" aria-hidden="true"></div>
      <div>
        <div>üçΩÔ∏è <span class="accent">Armor Vision</span> ‚Äî <b>Nutrition</b> <span class="badge">v1.5</span></div>
        <div class="muted" style="font-size:12px">S√®che ‚ö° ‚Ä¢ Maintien ‚öñÔ∏è ‚Ä¢ R√©paration üõ† ‚Ä¢ Masse üí™ ‚Ä¢ MTC üåøüî•‚ö°üíß</div>
      </div>
    </div>
    <div class="row">
      <a class="btn small" href="#">üèãÔ∏è Aller au Sport</a>
      <button class="btn small" onclick="window.print()">üñ®Ô∏è Imprimer</button>
    </div>
  </div>
</header>
<main>
  <!-- ACCUEIL -->
  <section id="dash">
    <h2>üìä Tableau de bord</h2>
    <div class="grid cols-4">
      <div class="kpi"><div>Poids actuel</div><b id="kpiWeight">‚Äî kg</b></div>
      <div class="kpi"><div>IMC</div><b id="kpiBMI">‚Äî</b></div>
      <div class="kpi"><div>Objectif</div><b id="kpiGoal">‚Äî kg</b></div>
      <div class="kpi"><div>Suivi global</div><b id="kpiAdherenceAll">‚Äî</b></div>
    </div>

    <div class="grid cols-2" style="margin-top:12px">
      <div class="card">
        <div class="row">
          <div class="muted">Programme actif : <b id="progLabel">‚Äî</b></div>
          <button class="btn right small primary" onclick="generateToday()">G√©n√©rer le plan du jour</button>
          <button class="btn small" onclick="setView('plan')">Voir le plan</button>
        </div>
        <div id="todayMeals" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <canvas id="weightChart" width="520" height="220" style="width:100%;height:auto;border:1px dashed var(--border);border-radius:12px"></canvas>
      </div>
    </div>

    <div id="nextUp" class="card">
      <h3>‚è≠Ô∏è Prochain repas</h3>
      <div id="nextMealText" class="muted">Aucun plan g√©n√©r√© pour aujourd‚Äôhui.</div>
      <ul id="nextMealItems" class="muted" style="margin:6px 0 0 16px"></ul>
      <div class="muted" id="nextMoveText" style="margin-top:6px"></div>
    </div>
  </section>

  <!-- PLAN -->
  <section id="plan" class="hidden">
    <div class="plan-title">
      <h2 style="margin:0">üçΩÔ∏è Plan</h2>
      <div class="plan-actions">
        <button class="btn ghost" id="btnAdjust" title="Ajuster (macros/horaires)">üß†</button>
        <button class="btn ghost" id="btnNotify" title="Notifier 45 min avant">üîî</button>
      </div>
    </div>

    <div class="card row plan-controls" style="align-items:flex-end">
      <div style="min-width:180px"><label>Date cible</label><input id="planJump" type="date"></div>
      <button class="btn small" onclick="jumpToPlanDate()">Aller √† cette date</button>
      <button class="btn small" onclick="scrollToday()">Aujourd‚Äôhui</button>
      <div class="right muted">Astuce : d√©filement + saut direct</div>
    </div>

    <div id="planWrap" class="grid cols-1"></div>
    <div class="end-spacer"></div>
  </section>

  <!-- COURSES -->
  <section id="shop" class="hidden">
    <h2>üõí Courses</h2>
    <div class="card row">
      <div class="seg" id="scopeSeg">
        <span class="chip active" data-scope="day">Jour</span>
        <span class="chip" data-scope="week">Semaine √† venir</span>
        <span class="chip" data-scope="4w">4 semaines</span>
      </div>
      <div class="right row">
        <input id="cityInput" placeholder="Ville / CP (ex : Chauriat 63117)" style="min-width:220px">
        <button class="btn small" onclick="useGPS()" title="Localisation automatique">üìç</button>
        <button class="btn small" onclick="refreshStores()" title="Actualiser magasins">‚Üª</button>
      </div>
    </div>

    <div class="grid cols-2">
      <div class="card">
        <h3>Liste interactive</h3>
        <div id="shopList"></div>
      </div>
      <div class="card">
        <h3>Magasins √† proximit√©</h3>
        <div id="storeBox" class="muted">Clique ‚Äúüìç‚Äù pour d√©tecter ta position ou saisis ta ville puis ‚Üª.</div>
        <details style="margin-top:8px">
          <summary>Comparateur (Top 5 moins chers)</summary>
          <div id="compareBox" class="muted">En attente de prix‚Ä¶</div>
        </details>
      </div>
    </div>

    <div class="controls-row">
      <button class="btn small" onclick="exportCSV()">Exporter CSV</button>
      <button class="btn small" onclick="exportState()">Export JSON (tout)</button>
      <label class="btn small" for="importFile">Importer JSON</label>
      <input class="hidden" id="importFile" type="file" accept="application/json">
    </div>
    <div class="end-spacer"></div>
  </section>

  <!-- SUIVI / IMC -->
  <section id="measures" class="hidden">
    <h2>üìà Suivi / IMC</h2>

    <div class="card">
      <canvas id="weightChart2" width="800" height="260" style="width:100%;height:auto"></canvas>
      <p class="muted">Courbe de poids avec lignes d√©part & objectif. IMC calcul√© automatiquement.</p>
    </div>

    <div class="card">
      <h3>Enregistrer des mesures</h3>
      <div class="grid cols-4">
        <input id="logDateWeight" type="date" title="Date">
        <input id="logWeight" type="number" step="0.1" placeholder="Poids (kg)">
        <input id="logWaist" type="number" step="0.1" placeholder="Taille (cm)">
        <input id="logHip" type="number" step="0.1" placeholder="Hanches (cm)">
        <input id="logChest" type="number" step="0.1" placeholder="Poitrine (cm)">
      </div>
      <div class="controls-row">
        <button class="btn small primary" onclick="addMeasuresBundle()">Ajouter</button>
        <button class="btn small" onclick="resetMeasures()">R√©initialiser</button>
      </div>
    </div>

    <div class="card">
      <h3>Historique (du plus ancien au plus r√©cent)</h3>
      <div id="measureList" class="muted"></div>
      <div class="controls-row">
        <button class="btn small" onclick="exportState()">Export JSON</button>
        <button class="btn small" onclick="window.print()">Imprimer</button>
        <label class="btn small" for="importFile2">Importer JSON</label>
        <input class="hidden" id="importFile2" type="file" accept="application/json">
      </div>
    </div>

    <div class="end-spacer"></div>
  </section>

  <!-- PARAM√àTRES -->
  <section id="settings" class="hidden">
    <h2>‚öôÔ∏è Param√®tres</h2>

    <div class="grid cols-3">
      <div><label>Sexe</label><select id="sex"><option value="male">Homme</option><option value="female">Femme</option></select></div>
      <div><label>√Çge (ans)</label><input id="age" type="number" min="14" max="90"></div>
      <div><label>Taille (cm)</label><input id="height" type="number" min="120" max="230"></div>
      <div><label>Poids (kg)</label><input id="weight" type="number" step="0.1" min="40" max="250"></div>
      <div><label>Objectif (kg)</label><input id="goal" type="number" step="0.1" min="40" max="250"></div>
      <div><label>Niveau d‚Äôactivit√©</label>
        <select id="activity"><option value="1.35">S√©dentaire (1.35)</option><option value="1.50">L√©ger (1.50)</option><option value="1.70">Mod√©r√© (1.70)</option></select>
      </div>
      <div><label>Ville / CP</label><input id="city" placeholder="Ex: Chauriat 63117"></div>
      <div><label>Heure de lever</label><input id="wake" type="time"></div>
      <div><label>Heure de coucher</label><input id="sleep" type="time"></div>
      <div><label>üéØ Objectif</label>
        <select id="objective">
          <option value="cut">S√®che (d√©ficit)</option>
          <option value="maintain">Maintien</option>
          <option value="rebuild">R√©paration</option>
          <option value="bulk">Prise de muscle</option>
        </select>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:10px">
      <div class="card">
        <h3>Affichage</h3>
        <div class="row">
          <div class="seg" id="themeSegSettings">
            <span class="chip" data-t="jarvis">Jarvis</span>
            <span class="chip active" data-t="xvision">X-VISION</span>
            <span class="chip" data-t="shield">SHIELD</span>
          </div>
          <label class="row right" style="gap:6px"><input id="modeToggleSettings" type="checkbox"> Mode clair</label>
        </div>
        <div class="row" style="margin-top:6px">
          <label>Couleur d‚Äôaccent</label>
          <input id="accentPicker" type="color" style="max-width:120px" value="#ff7a18">
          <button class="btn small" onclick="resetAccent()">R√©init.</button>
        </div>
        <p class="muted">Les th√®mes adoptent une palette diff√©rente si ‚ÄúFemme‚Äù est s√©lectionn√©.</p>
      </div>

      <div class="card">
        <h3>Pr√©f√©rences</h3>
        <div class="pref-grid">
          <label><input id="prefNoFish" type="checkbox">√âviter le poisson</label>
          <label><input id="prefLactoseLow" type="checkbox">Limiter lactose</label>
          <label><input id="prefBudget" type="checkbox">Budget serr√©</label>
          <label><input id="prefLocal" type="checkbox">Favoriser local & saison</label>
        </div>
        <textarea id="prefExtra" placeholder="Autres pr√©f√©rences (texte libre)" style="margin-top:8px"></textarea>
      </div>
    </div>

    <div class="grid cols-2" style="margin-top:10px">
      <div class="card">
        <h3>Restrictions & r√©gimes</h3>
        <div class="pref-grid">
          <label><input id="rNoPork" type="checkbox">Sans porc</label>
          <label><input id="rHalal" type="checkbox">Halal-friendly</label>
          <label><input id="rKosher" type="checkbox">Casher-friendly</label>
          <label><input id="rVeggie" type="checkbox">V√©g√©tarien</label>
          <label><input id="rVegan" type="checkbox">Vegan</label>
          <label><input id="rNoGluten" type="checkbox">Sans gluten</label>
          <label><input id="rNoLactose" type="checkbox">Sans lactose</label>
          <label><input id="rNutAllergy" type="checkbox">Allergie fruits √† coque</label>
          <label><input id="rEggAllergy" type="checkbox">Allergie ≈ìuf</label>
          <label><input id="rSoyAllergy" type="checkbox">Allergie soja</label>
        </div>
        <textarea id="allergiesExtra" placeholder="Allergies / intol√©rances / non souhait√©s (texte libre)" style="margin-top:8px"></textarea>
      </div>

      <div class="card">
        <h3>Donn√©es & cache</h3>
        <div class="controls-row">
          <button class="btn small" onclick="exportState()">Exporter tout (JSON)</button>
          <label class="btn small" for="importFile3">Importer JSON</label>
          <input class="hidden" id="importFile3" type="file" accept="application/json">
          <button class="btn small" onclick="clearCaches()">Effacer cache</button>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn small primary" onclick="saveSettings()">Enregistrer</button>
      <button class="btn small" onclick="resetAll()">R√©initialiser tout</button>
    </div>

    <div class="card" style="margin-top:12px">
      <details open id="legalShort">
        <summary>‚ö†Ô∏è Avis important (sant√©)</summary>
        <p class="muted">Ce document ne remplace pas un avis m√©dical, nutritionnel ou de professionnel de sant√©. Les recommandations sont g√©n√©riques, fournies ‚Äúen l‚Äô√©tat‚Äù, et doivent √™tre adapt√©es √† ta situation (pathologies, traitements, allergies). En cas de doute, consulte un professionnel qualifi√©. En utilisant ce fichier, tu reconnais √™tre seul responsable de tes d√©cisions alimentaires et d‚Äôactivit√© physique.</p>
      </details>
      <details>
        <summary>üîí Mentions l√©gales & licence</summary>
        <p class="muted">¬© Armor Vision. Usage personnel uniquement. Reproduction/diffusion/revente interdites. L‚Äô√©diteur d√©cline toute responsabilit√© en cas d‚Äôusage non conforme ou de dommages indirects. Les marques cit√©es appartiennent √† leurs propri√©taires.</p>
      </details>
    </div>

    <div class="end-spacer"></div>
  </section>
</main>
<nav class="bottom">
  <button class="btn" id="nav-dash" onclick="setView('dash')">üè† Accueil</button>
  <button class="btn" id="nav-plan" onclick="setView('plan')">üçΩÔ∏è Plan</button>
  <button class="btn" id="nav-shop" onclick="setView('shop')">üõí Courses</button>
  <button class="btn" id="nav-measures" onclick="setView('measures')">üìà Suivi / IMC</button>
  <button class="btn icon-only" id="nav-settings" title="Param√®tres" onclick="setView('settings')">‚öôÔ∏è</button>
</nav>
<!-- MODAL Ajuster (üß†) -->
<div class="modal" id="adjustModal">
  <div class="backdrop" onclick="closeModal('adjustModal')"></div>
  <div class="sheet">
    <div class="close-x" onclick="closeModal('adjustModal')">‚úñ</div>
    <h3>üß† Ajuster le plan</h3>
    <div class="grid cols-3">
      <div><label>Cible kcal</label><input id="adjKcal" type="number" placeholder="ex 2200"></div>
      <div><label>P (%)</label><input id="adjP" type="number" step="1" placeholder="ex 30"></div>
      <div><label>G (%)</label><input id="adjF" type="number" step="1" placeholder="ex 25"></div>
    </div>
    <p class="muted">Les horaires sont recalcul√©s autour des heures de lever/coucher.</p>
    <div class="controls-row">
      <button class="btn small primary" onclick="applyAdjust()">Appliquer</button>
      <button class="btn small" onclick="closeModal('adjustModal')">Annuler</button>
    </div>
  </div>
</div>

<!-- MODAL Substitutions -->
<div class="modal" id="equivModal">
  <div class="backdrop" onclick="closeModal('equivModal')"></div>
  <div class="sheet">
    <div class="close-x" onclick="closeModal('equivModal')">‚úñ</div>
    <h3>üîÅ Substituer un aliment</h3>
    <div id="equivContent" class="grid cols-1"></div>
    <label class="row" style="margin-top:8px"><input id="applyFuture" type="checkbox" checked>Appliquer aux jours <b>√† venir</b> uniquement</label>
    <div class="controls-row">
      <button class="btn small" onclick="closeModal('equivModal')">Fermer</button>
    </div>
  </div>
</div>

<!-- MODAL Avertissement initial -->
<div class="modal" id="legalModal">
  <div class="backdrop" onclick="acceptLegal()"></div>
  <div class="sheet">
    <h3>‚ö†Ô∏è Avant de commencer</h3>
    <p class="muted">Ce fichier ne remplace pas un avis m√©dical. En continuant, tu acceptes les avertissements et la licence figurant dans Param√®tres.</p>
    <div class="controls-row">
      <button class="btn small primary" onclick="acceptLegal()">J‚Äôaccepte</button>
    </div>
  </div>
</div>
<script>
const VERSION = '1.5';
const state = {
  version: VERSION, accepted:false,
  mode:'dark', theme:'xvision', accentCustom:null, sexClass:'male',
  user:{sex:'male',age:35,height:180,weight:null,startWeight:null,goal:72,activity:1.50,
        city:'',wake:'06:30',sleep:'22:30',
        prefs:{noFish:false,lactoseLow:false,budget:true,local:true, extra:''},
        restrict:{}, allergiesExtra:''},
  program:'cut', // cut | maintain | rebuild | bulk (pilot√© par Param√®tres -> objective)
  plan:{meals:[]}, planWeeks:[], adherence:{},
  weightLog:[], measureLog:[],
  shop:{scope:'day', checked:{}, stores:[], prices:{}},
  notify:{enabled:false, timer:null},
  adjust:null
};

function save(){
  try{ localStorage.setItem('av-nutri-v15', JSON.stringify(state)); }
  catch(e){ console.warn('Sauvegarde locale indisponible:', e); return false; }
  return true;
}
function load(){
  try{
    const s=JSON.parse(localStorage.getItem('av-nutri-v15'));
    if(s){ Object.assign(state,s); if(s.version!==VERSION){ state.version=VERSION; state.accepted=false; } }
  }catch(e){ console.warn('Lecture locale indisponible:', e); }
  applyMode(state.mode); applySex(state.user.sex); applyTheme(state.theme); if(state.accentCustom) setAccent(state.accentCustom);
  fillSettings(); initThemeChips(); initScopeChips(); updateNavActive('dash');
  updateProgLabel(); updateKPI(); renderWeightChart(); renderChartsDetail(); renderMeasureList(); renderNextUp();
  const cityI=document.getElementById('cityInput'); if(cityI) cityI.value=state.user.city||'';
  ['importFile','importFile2','importFile3'].forEach(id=>{ const el=document.getElementById(id); if(el) el.onchange=importJSON; });
  if(!state.accepted) openModal('legalModal');
}
document.addEventListener('DOMContentLoaded', load);

/* Th√®mes / Modes / Accent */
function setAccent(hex){ document.documentElement.style.setProperty('--accent', hex); }
function resetAccent(){ state.accentCustom=null; setAccent(getComputedStyle(document.documentElement).getPropertyValue('--accent')); save(); }
function applyTheme(t){
  state.theme=t;
  document.body.classList.remove('theme-jarvis','theme-xvision','theme-shield','male','female');
  document.body.classList.add('theme-'+t, state.sexClass);
  document.querySelectorAll('#themeSegSettings .chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.t===t));
  if(state.accentCustom) setAccent(state.accentCustom);
  save();
}
function applyMode(m){ state.mode=m; document.body.classList.toggle('light', m==='light'); save(); }
function applySex(sex){ state.sexClass=(sex==='female')?'female':'male'; document.body.classList.remove('male','female'); document.body.classList.add(state.sexClass); }

/* Navigation */
function setView(id){
  document.querySelectorAll('main > section').forEach(s=> s.id===id ? s.classList.remove('hidden') : s.classList.add('hidden'));
  updateNavActive(id);
  if(id==='plan'){ renderPlan(); }
  if(id==='shop'){ renderShop(); }
  if(id==='measures'){ renderChartsDetail(); renderMeasureList(); }
  if(id==='dash'){ renderNextUp(); }
  window.scrollTo({top:0,behavior:'smooth'});
}
function updateNavActive(id){
  ['dash','plan','shop','measures','settings'].forEach(k=>{
    const b=document.getElementById('nav-'+k); if(!b) return;
    b.classList.toggle('active', id===k);
  });
}

/* UI helpers & avertissement */
function openModal(id){ document.getElementById(id).classList.add('show'); }
function closeModal(id){ document.getElementById(id).classList.remove('show'); }
function acceptLegal(){
  state.accepted=true; closeModal('legalModal');
  const ok=save(); if(!ok){ setTimeout(()=>alert("Note : la sauvegarde locale est indisponible (mode priv√©/quota). L‚Äôavertissement pourra r√©appara√Ætre."), 0); }
}
/* Param√®tres */
function initThemeChips(){
  const root=document.getElementById('themeSegSettings');
  if(!root) return;
  root.querySelectorAll('.chip').forEach(ch=>{
    ch.classList.toggle('active', ch.dataset.t===state.theme);
    ch.onclick=()=>{ applyTheme(ch.dataset.t); };
  });
  const t=document.getElementById('modeToggleSettings'); if(t){ t.checked=(state.mode==='light'); t.onchange=()=>applyMode(t.checked?'light':'dark'); }
  const p=document.getElementById('accentPicker'); if(p){ p.value = state.accentCustom || '#ff7a18'; p.oninput=()=>{ state.accentCustom=p.value; setAccent(p.value); save(); }; }
}
function programLabel(p){
  return p==='cut'?'‚ö° S√®che':p==='maintain'?'‚öñÔ∏è Maintien':p==='rebuild'?'üõ† R√©paration':'üí™ Masse';
}
function updateProgLabel(){
  const el=document.getElementById('progLabel'); if(el) el.textContent=programLabel(state.program);
}
function fillSettings(){
  const u=state.user;
  sex.value=u.sex||'male'; document.getElementById('objective').value=state.program||'cut';
  age.value=u.age||35; height.value=u.height||180;
  weight.value=(u.weight??''); goal.value=u.goal||72; activity.value=u.activity||1.50;
  city.value=u.city||''; wake.value=u.wake||''; sleep.value=u.sleep||'';
  prefNoFish.checked=!!u.prefs.noFish; prefLactoseLow.checked=!!u.prefs.lactoseLow; prefBudget.checked=!!u.prefs.budget; prefLocal.checked=!!u.prefs.local;
  prefExtra.value = u.prefs.extra||'';
  u.restrict=u.restrict||{};
  ['rNoPork','rHalal','rKosher','rVeggie','rVegan','rNoGluten','rNoLactose','rNutAllergy','rEggAllergy','rSoyAllergy'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.checked=!!u.restrict[id];
  });
  allergiesExtra.value = u.allergiesExtra||'';
}
function saveSettings(){
  const u=state.user;
  u.sex=sex.value; applySex(u.sex); applyTheme(state.theme);
  u.age=+age.value||35; u.height=+height.value||180;
  const w=weight.value; u.weight=(w==='')?null:+w; if(u.startWeight===null&&u.weight) u.startWeight=u.weight;
  u.goal=+goal.value||72; u.activity=+activity.value||1.50; u.city=city.value||'';
  u.wake=wake.value||null; u.sleep=sleep.value||null;
  u.prefs.noFish=prefNoFish.checked; u.prefs.lactoseLow=prefLactoseLow.checked; u.prefs.budget=prefBudget.checked; u.prefs.local=prefLocal.checked;
  u.prefs.extra = prefExtra.value||'';
  u.restrict=u.restrict||{}; ['rNoPork','rHalal','rKosher','rVeggie','rVegan','rNoGluten','rNoLactose','rNutAllergy','rEggAllergy','rSoyAllergy']
    .forEach(id=>{ const el=document.getElementById(id); if(el) u.restrict[id]=!!el.checked; });
  u.allergiesExtra = allergiesExtra.value||'';
  state.program = document.getElementById('objective').value || 'cut';
  const mt=document.getElementById('modeToggleSettings'); if(mt) applyMode(mt.checked?'light':'dark');
  state.user=u; state.user.city && (document.getElementById('cityInput').value=state.user.city);
  save(); fillSettings(); updateProgLabel(); updateKPI(); renderNextUp(); renderPlan(); renderShop();
}
function clearCaches(){ localStorage.removeItem('av-nutri-v15'); if(window.caches){caches.keys().then(keys=>keys.forEach(k=>caches.delete(k)));} alert('Cache local effac√©. Recharger la page.'); }
function resetAll(){ if(!confirm('R√©initialiser toutes les donn√©es ?')) return; localStorage.removeItem('av-nutri-v15'); location.reload(); }

/* Mifflin-St Jeor + TDEE */
function bmr(u){
  const w=u.weight||75, h=u.height||180, a=u.age||35;
  const s = (u.sex==='male') ? 5 : -161;
  return Math.round(10*w + 6.25*h - 5*a + s);
}
function tdee(u){ return Math.round(bmr(u) * (u.activity||1.50)); }

/* Cibles macros selon programme */
function macroTargets(u, program){
  const W = u.weight||75;
  let kcal = tdee(u), prot_g, fat_g, carb_g;
  if(program==='cut'){ // d√©ficit ~20%
    kcal = Math.round(kcal*0.8);
    prot_g = Math.max(2.0*W, 1.8*W);
    fat_g = Math.max(0.6*W, Math.round(kcal*0.22/9));
  }else if(program==='bulk'){ // surplus ~12%
    kcal = Math.round(kcal*1.12);
    prot_g = 1.8*W;
    fat_g = Math.round(kcal*0.25/9);
  }else if(program==='rebuild'){ // recomp l√©g√®re
    kcal = Math.round(kcal*0.98);
    prot_g = 2.0*W;
    fat_g = Math.round(kcal*0.25/9);
  }else{ // maintain
    kcal = Math.round(kcal);
    prot_g = 1.8*W;
    fat_g = Math.round(kcal*0.25/9);
  }
  const prot_kcal = prot_g*4;
  const fat_kcal = fat_g*9;
  carb_g = Math.max(0, Math.round((kcal - prot_kcal - fat_kcal)/4));
  return {kcal, prot_g:Math.round(prot_g), fat_g:Math.round(fat_g), carb_g};
}
/* Courbes & IMC & Historique */
function bmi(w,h){if(!w||!h)return null; const v=w/Math.pow(h/100,2); return Math.round(v*10)/10;}
function line(ctx,pts){ctx.beginPath(); for(let i=0;i<pts.length;i++){const p=pts[i]; i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y);} ctx.stroke();}
function scaleX(i,n,w,p=30){return p+(w-2*p)*(i/(Math.max(1,n-1)));} function scaleY(v,min,max,h,p=20){const k=(v-min)/(max-min||1); return h-p-(h-2*p)*k;}

function renderWeightChart(){
  const c=document.getElementById('weightChart'); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  const data=state.weightLog.map(e=>({d:e.d,w:e.w})); if(!data.length){ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--muted'); ctx.fillText('Ajoute des mesures pour voir la courbe.',10,20); return;}
  const ws=data.map(e=>e.w), min=Math.min(...ws, state.user.goal||ws[0]), max=Math.max(...ws, state.user.startWeight||ws[0]);
  const pts=data.map((e,i)=>({x:scaleX(i,data.length,c.width),y:scaleY(e.w,min,max,c.height)}));
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--accent'); ctx.lineWidth=2; line(ctx,pts);
  const yStart=scaleY(state.user.startWeight??ws[0],min,max,c.height), yGoal=scaleY(state.user.goal??ws[0],min,max,c.height);
  ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(150,150,160,.6)'; ctx.beginPath(); ctx.moveTo(20,yStart); ctx.lineTo(c.width-20,yStart); ctx.stroke();
  ctx.strokeStyle='rgba(80,180,120,.8)'; ctx.beginPath(); ctx.moveTo(20,yGoal); ctx.lineTo(c.width-20,yGoal); ctx.stroke(); ctx.setLineDash([]);
}
function renderChartsDetail(){
  const c=document.getElementById('weightChart2'); if(!c) return; const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  const data=state.weightLog; if(!data.length){ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--muted'); ctx.fillText('Ajoute des mesures pour voir la courbe.',10,20); return;}
  const ws=data.map(e=>e.w), min=Math.min(...ws, state.user.goal||ws[0]), max=Math.max(...ws, state.user.startWeight||ws[0]);
  const pts=data.map((e,i)=>({x:scaleX(i,data.length,c.width),y:scaleY(e.w,min,max,c.height)}));
  ctx.strokeStyle=getComputedStyle(document.body).getPropertyValue('--accent'); ctx.lineWidth=2; line(ctx,pts);
  const yStart=scaleY(state.user.startWeight??ws[0],min,max,c.height), yGoal=scaleY(state.user.goal??ws[0],min,max,c.height);
  ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(150,150,160,.6)'; ctx.beginPath(); ctx.moveTo(20,yStart); ctx.lineTo(c.width-20,yStart); ctx.stroke();
  ctx.strokeStyle='rgba(80,180,120,.8)'; ctx.beginPath(); ctx.moveTo(20,yGoal); ctx.lineTo(c.width-20,yGoal); ctx.stroke(); ctx.setLineDash([]);
}
function addMeasuresBundle(){
  const d=(logDateWeight.value||new Date().toISOString().slice(0,10));
  if(logWeight.value){ const w=parseFloat(logWeight.value); state.user.weight=w; if(state.user.startWeight===null) state.user.startWeight=w; state.weightLog.push({d,w}); logWeight.value=''; }
  const wst=parseFloat(logWaist.value)||null, hipv=parseFloat(logHip.value)||null, ch=parseFloat(logChest.value)||null;
  if(wst||hipv||ch) state.measureLog.push({d, waist:wst, hip:hipv, chest:ch});
  ['logWaist','logHip','logChest','logDateWeight'].forEach(id=>{const e=document.getElementById(id); if(e) e.value='';});
  save(); updateKPI(); renderWeightChart(); renderChartsDetail(); renderMeasureList(); renderNextUp();
}
function resetMeasures(){ if(confirm('Effacer tout l‚Äôhistorique (poids + mensurations) ?')){ state.weightLog=[]; state.measureLog=[]; save(); renderWeightChart(); renderChartsDetail(); renderMeasureList(); } }
function renderMeasureList(){
  const el=document.getElementById('measureList'); if(!el) return;
  const all = [...state.weightLog.map(e=>({d:e.d, type:'Poids', txt:`${e.w} kg (IMC ${bmi(e.w,state.user.height)??'‚Äî'})`})),
               ...state.measureLog.map(e=>({d:e.d, type:'Mensurations', txt:[e.waist?`Taille ${e.waist} cm`:null, e.hip?`Hanches ${e.hip} cm`:null, e.chest?`Poitrine ${e.chest} cm`:null].filter(Boolean).join(' ‚Ä¢ ')}))];
  all.sort((a,b)=>a.d.localeCompare(b.d));
  el.innerHTML = `<table class="table">${all.map(r=>`<tr><td>${r.d}</td><td class="muted">${r.type}</td><td>${r.txt||'‚Äî'}</td></tr>`).join('')}</table>`;
}

/* KPI & prochain repas */
function adherenceOverall(){
  const days=(state.planWeeks||[]).filter(d=>d.date<=new Date().toISOString().slice(0,10));
  if(!days.length) return '‚Äî';
  let sum=0, cnt=0;
  for(const d of days){
    const g=state.adherence[d.date]||{}; const keys=Object.keys(g); if(!keys.length) continue;
    const ok=keys.filter(k=>g[k]).length/keys.length; sum+=ok; cnt++;
  }
  if(!cnt) return '‚Äî';
  return Math.round(100*(sum/cnt))+'%';
}
function updateKPI(){
  const u=state.user;
  document.getElementById('kpiWeight').textContent=(u.weight??'‚Äî')+' kg';
  document.getElementById('kpiBMI').textContent=bmi(u.weight,u.height)??'‚Äî';
  document.getElementById('kpiGoal').textContent=(u.goal??'‚Äî')+' kg';
  document.getElementById('kpiAdherenceAll').textContent=adherenceOverall();
}
function getNextMeal(){
  if(!state.plan.meals || !state.plan.meals.length) return null;
  const now=new Date(), base=new Date();
  const meals=state.plan.meals.map(m=>{const [hh,mm]=m.time.split(':').map(Number); const d=new Date(base); d.setHours(hh,mm,0,0); return {...m,_d:d};});
  return meals.find(m=>m._d>now) || meals[meals.length-1];
}
function renderNextUp(){
  const elT=document.getElementById('nextMealText'), elItems=document.getElementById('nextMealItems'), elMove=document.getElementById('nextMoveText');
  const n=getNextMeal(); if(!n){ elT.textContent='G√©n√®re un plan pour voir le prochain repas.'; elItems.innerHTML=''; elMove.textContent=''; return; }
  elT.innerHTML = `<b>${n.time} ‚Äî ${n.name}</b>`;
  elItems.innerHTML = n.items.map(it=>`<li>${it.food} ‚Äî ${it.grams}${it.units? ' | '+it.units+' dose(s)':' g'}</li>`).join('');
  elMove.textContent='Conseil mouvement : marche active 20‚Äì40 min (id√©al apr√®s d√©jeuner ou fin d‚Äôapr√®s-midi).';
}
/* Aliments (‚âà valeurs/100g ou par unit√©) + tags MTC */
const FOODS={
  "fromage blanc 0%":{per:'g',p:10,c:4,f:0, mtc:"üåø rafra√Æchissant (Yin)"},
  "skyr (125g)":{per:'g',p:11,c:4,f:0, mtc:"üåø neutre/Yin"},
  "boisson soja nature":{per:'ml', displayUnit:'ml',p:3.2,c:2.1,f:1.8, mtc:"üåø Yin"},
  "flocons d'avoine":{per:'g',p:13,c:62,f:7, mtc:"‚ö° tonifie Qi / Terre"},
  "fruits rouges (m√©lange)":{per:'g',p:1,c:12,f:0.4, mtc:"üåø Yin / Sang"},
  "whey (dose 30g)":{per:'unit',displayUnit:'g',p:24,c:3,f:2, mtc:"‚ö° Qi / r√©cup√©ration"},
  "pomme":{per:'g',p:0.3,c:14,f:0.2, mtc:"üåø Yin / humidit√© l√©g√®re"},
  "banane":{per:'g',p:1.1,c:23,f:0.3, mtc:"üåø Yin / humidit√©"},
  "blanc de poulet (cru)":{per:'g',cookedRatio:0.75,p:22,c:0,f:2, mtc:"‚ö° tonifie Qi / Yang doux"},
  "dinde (cru)":{per:'g',cookedRatio:0.75,p:22,c:0,f:2, mtc:"‚ö° Qi / Yang"},
  "saumon (cru)":{per:'g',cookedRatio:0.8,p:20,c:0,f:13, mtc:"üî• r√©chauffant + Sang"},
  "tofu ferme":{per:'g',p:12,c:3,f:7, mtc:"üåø Yin / humidit√© mod√©r√©e"},
  "oeufs (2 unit√©s ~120g)":{per:'unit',p:13,c:1.1,f:10, mtc:"‚ö° Essence / Sang"},
  "riz basmati (sec)":{per:'g',note:'~3√ó cuit',p:7,c:77,f:1, mtc:"‚öñÔ∏è neutre (Terre)"},
  "semoule (sec)":{per:'g',note:'~2.7√ó cuit',p:12,c:73,f:1, mtc:"‚öñÔ∏è neutre"},
  "l√©gumineuses cuites":{per:'g',p:7.5,c:27,f:0.6, mtc:"üåø Yin / humidit√© possible"},
  "huile d'olive":{per:'g',p:0,c:0,f:100, mtc:"üî• r√©chauffant doux"},
  "brocoli (cuit)":{per:'g',p:2.8,c:7,f:0.4, mtc:"üåø draine Humidit√©/Chaleur"},
  "haricots verts (cuits)":{per:'g',p:1.8,c:7,f:0.2, mtc:"üåø Yin / Bois"},
  "courgette (cuisin√©e)":{per:'g',p:1.2,c:4,f:0.2, mtc:"üåø rafra√Æchissant (Yin)"},
  "salade verte":{per:'g',p:1.4,c:2.9,f:0.2, mtc:"üåø Yin / Bois"}
};
const EQUIV={
  "fromage blanc 0%":["skyr (125g)","boisson soja nature"],
  "skyr (125g)":["fromage blanc 0%","boisson soja nature"],
  "whey (dose 30g)":["fromage blanc 0%","skyr (125g)","oeufs (2 unit√©s ~120g)"],
  "pomme":["banane","fruits rouges (m√©lange)"],
  "riz basmati (sec)":["semoule (sec)","l√©gumineuses cuites"],
  "blanc de poulet (cru)":["dinde (cru)","tofu ferme","saumon (cru)"],
  "dinde (cru)":["blanc de poulet (cru)","tofu ferme","saumon (cru)"],
  "saumon (cru)":["blanc de poulet (cru)","tofu ferme"],
  "brocoli (cuit)":["haricots verts (cuits)","courgette (cuisin√©e)","salade verte"],
  "haricots verts (cuits)":["brocoli (cuit)","courgette (cuisin√©e)","salade verte"]
};

/* S√©lecteurs selon pr√©f√©rences/restrictions */
function pickProtein(){
  const r=state.user.restrict||{}, p=state.user.prefs||{};
  if(r.rVegan) return "tofu ferme";
  if(r.rVeggie) return p.lactoseLow? "skyr (125g)" : "fromage blanc 0%";
  if(r.rNoPork) return state.user.prefs.noFish? "blanc de poulet (cru)" : "saumon (cru)";
  return state.user.prefs.noFish? "blanc de poulet (cru)" : "saumon (cru)";
}
function pickDairy(){
  const r=state.user.restrict||{}, p=state.user.prefs||{};
  if(r.rVegan) return "boisson soja nature";
  if(r.rNoLactose||p.lactoseLow) return "skyr (125g)";
  return "fromage blanc 0%";
}
function pickCarb(){ return "riz basmati (sec)"; }

/* R√©partition journali√®re (PDJ, Coll1, D√©j, Coll2, D√Æner, Snack optionnel) */
const SLOT = [0.25,0.10,0.30,0.10,0.25];
function timeStr(h,m){return String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');}

/* G√©n√©ration d‚Äôun jour selon programme + tags MTC */
function composeDay(program){
  const u=state.user, mt=macroTargets(u, program);
  const prot = pickProtein(), dairy=pickDairy(), carb1=pickCarb();
  const vegLunch = "brocoli (cuit)", vegDinner="haricots verts (cuits)";

  function fitMeal(){
    const items=[];
    const baseP = (program==='cut'? 40 : 35); // ‚âà 200g cru
    items.push({food: prot, grams: baseP*5});
    const carbG = (program==='cut'? 30 : program==='bulk'? 45 : 35);
    items.push({food: carb1, grams: carbG});
    const fatG = (program==='bulk'? 12 : program==='cut'? 8 : 10);
    items.push({food: "huile d'olive", grams: fatG});
    return items;
  }

  const meals = [
    { time: timeStr(6,45), name:'Petit-d√©jeuner', items:[
      {food:dairy, grams: (program==='cut'? 220:250)},
      {food:"flocons d'avoine", grams:(program==='bulk'? 45: (program==='cut'? 22:30))},
      {food:"fruits rouges (m√©lange)", grams:80}
    ]},
    { time: timeStr(10,0), name:'Collation matin', items:[
      {food:"whey (dose 30g)", grams:30, units:1},
      {food:"pomme", grams:150}
    ]},
    { time: timeStr(12,45), name:'D√©jeuner', items:[...fitMeal(), {food:vegLunch, grams:150}]},
    { time: timeStr(16,30), name:'Collation apr√®s-midi', items:[
      {food:"whey (dose 30g)", grams:30, units:1},
      {food:"banane", grams: (program==='cut'?110:140)}
    ]},
    { time: timeStr(19,15), name:'D√Æner', items:[...fitMeal(), {food:vegDinner, grams:150}]}
  ];

  if(program==='bulk' || program==='rebuild'){
    meals.push({ time: timeStr(22,0), name:"Snack tardif (optionnel)", items:[
      {food: pickDairy(), grams:180}
    ]});
  }

  return {meals, targets: mt};
}
/* Construire 4 semaines si n√©cessaire */
function ensureWeeks(){
  if(!state.plan.meals.length) return;
  if(!state.planWeeks.length){
    const weeks=[], base=new Date();
    for(let i=0;i<28;i++){const d=new Date(base); d.setDate(base.getDate()+i); weeks.push({date:d.toISOString().slice(0,10), meals:JSON.parse(JSON.stringify(state.plan.meals))});}
    state.planWeeks=weeks; save();
  }
}
function mtcTag(food){ return (FOODS[food] && FOODS[food].mtc) ? ` <span class="muted">‚Ä¢ ${FOODS[food].mtc}</span>` : ''; }

function renderPlan(){
  const wrap=document.getElementById('planWrap');
  if(!state.plan.meals.length){ wrap.innerHTML='<p class="muted">Clique ‚ÄúG√©n√©rer le plan du jour‚Äù.</p>'; return; }
  ensureWeeks();
  const todayStr=new Date().toISOString().slice(0,10);

  const conv=(it)=>{const f=FOODS[it.food]||{}; let extra='';
    if(f.cookedRatio) extra=` | ~${Math.round(it.grams*f.cookedRatio)} g cuit`;
    if(f.per==='unit' && it.units!==undefined) extra=` | ${it.units} dose(s)`;
    if(f.displayUnit==='ml') extra=` | ${it.grams} ml`;
    if(f.note) extra+=` <span class="muted">(${f.note})</span>`;
    return extra + mtcTag(it.food);
  };

  const dayHTML=(day)=>{
    let html=`<a id="d-${day.date}"></a><div class="card" style="margin-bottom:10px; ${day.date===todayStr?'border:2px solid var(--accent)':''}"><h3>${day.date===todayStr?'‚≠ê ':''}${day.date}</h3>`;
    let last=''; day.meals.forEach((m,mi)=>{
      const group=m.name.split(' ')[0], show=(group!==last);
      if(show){
        const checked=(state.adherence[day.date]||{})[group]?'checked':''; 
        html+=`<div class="row" style="align-items:center;gap:8px;margin-top:6px">
          <label class="row" style="gap:6px"><input type="checkbox" ${checked} onchange="toggleAdherence('${day.date}','${group}',this.checked)"> <b style="color:var(--accent)">${m.time} ‚Äî ${group}</b></label>
        </div>`;
        last=group;
      }
      html+=`<table class="table">${m.items.map((it,ii)=>`<tr>
        <td class="muted">${show?'Aliment':''}</td>
        <td><span class="link" onclick="equivOpen('${day.date}',${mi},${ii}, '${it.food.replace(/'/g,"\\'")}')">${it.food}</span>${conv(it)}</td>
        <td style="text-align:right">${it.grams}${(FOODS[it.food]&&FOODS[it.food].per==='unit'&&it.units!==undefined)?' | '+it.units+' dose(s)':' g'}</td>
      </tr>`).join('')}</table>`;
    });
    html+='</div>'; return html;
  };
  wrap.innerHTML=(state.planWeeks||[]).map(dayHTML).join('');
}
function scrollToday(){ const ds='d-'+new Date().toISOString().slice(0,10); const el=document.getElementById(ds); if(el) el.scrollIntoView({behavior:'smooth'}); }
function jumpToPlanDate(){ const d=planJump.value; if(!d) return; const el=document.getElementById('d-'+d); if(el) el.scrollIntoView({behavior:'smooth'}); }

/* Adh√©rence */
function toggleAdherence(date, group, checked){
  state.adherence[date] = state.adherence[date] || {};
  state.adherence[date][group] = !!checked;
  save(); updateKPI();
}

/* Substitutions via modal */
let equivCtx=null;
function equivOpen(date,mi,ii,food){
  equivCtx={date,mi,ii,food};
  const opts=EQUIV[food]||[];
  const box=document.getElementById('equivContent');
  box.innerHTML = opts.length? opts.map(o=>`<button class="btn small" onclick="equivChoose('${o.replace(/'/g,"\\'")}')">${o}</button>`).join(' ')
                            : `<p class="muted">Pas d‚Äô√©quivalences pr√©d√©finies pour ¬´ ${food} ¬ª.</p>`;
  openModal('equivModal');
}
function equivChoose(choice){
  if(!equivCtx) return;
  const {date,mi,ii,food}=equivCtx;
  const futureOnly=document.getElementById('applyFuture').checked;
  let apply=false;
  for(const d of state.planWeeks){
    if(d.date===date){ apply=true; }
    if(futureOnly && d.date<date) continue;
    if(apply && d.meals[mi] && d.meals[mi].items[ii]){
      if(!futureOnly || d.meals[mi].items[ii].food===food){ d.meals[mi].items[ii].food = choice; }
    }
  }
  save(); renderPlan(); closeModal('equivModal'); renderShop();
}

/* Ajuster (üß†) */
document.getElementById('btnAdjust').onclick=()=>openModal('adjustModal');
function applyAdjust(){
  state.adjust = { kcal:+(adjKcal.value||0), p:+(adjP.value||0), f:+(adjF.value||0) };
  save(); closeModal('adjustModal');
}

/* Notifications (üîî) 45 min avant prochain repas */
document.getElementById('btnNotify').onclick=toggleNotify;
function toggleNotify(){
  if(!('Notification' in window)){ alert('Notifications non support√©es dans ce navigateur.'); return; }
  if(Notification.permission==='granted'){ state.notify.enabled=!state.notify.enabled; save(); scheduleNextNotification(); updateBellUI(); }
  else if(Notification.permission!=='denied'){ Notification.requestPermission().then(p=>{ if(p==='granted'){ state.notify.enabled=true; save(); scheduleNextNotification(); updateBellUI(); } }); }
  else alert('Autorise les notifications dans les r√©glages du navigateur.');
}
function updateBellUI(){ document.getElementById('btnNotify').style.opacity = state.notify.enabled? 1 : 0.5; }
function scheduleNextNotification(){
  if(state.notify.timer){ clearTimeout(state.notify.timer); state.notify.timer=null; }
  if(!state.notify.enabled) return;
  const n=getNextMeal(); if(!n) return;
  const when = new Date(n._d||new Date()); when.setMinutes(when.getMinutes()-45);
  const delay = when - new Date();
  if(delay<=0){ return; }
  state.notify.timer = setTimeout(()=>{
    try{ new Notification('Prochain repas', { body: `${n.time} ‚Äî ${n.name}` }); }catch(_){}
  }, delay);
}
updateBellUI();

/* G√©n√©ration du plan du jour (selon l‚Äôobjectif Param√®tres) */
function generateToday(){
  const {meals, targets} = composeDay(state.program||'cut');
  state.plan.meals = meals;
  state.planWeeks=[]; // Recalc √† partir d‚Äôaujourd‚Äôhui
  ensureWeeks();
  save(); renderPlan(); renderShop();
  document.getElementById('todayMeals').innerHTML = meals.map(m=>`<div><b>${m.time}</b> ‚Äî ${m.name}</div>`).join('') + 
    `<div class="muted" style="margin-top:6px">Cibles ~ ${targets.kcal} kcal ‚Ä¢ P ${targets.prot_g}g ‚Ä¢ G ${targets.fat_g}g ‚Ä¢ C ${targets.carb_g}g</div>`;
  updateProgLabel(); renderNextUp(); scheduleNextNotification(); updateBellUI();
}
/* Courses */
function initScopeChips(){
  const root=document.getElementById('scopeSeg');
  if(!root) return;
  root.querySelectorAll('.chip').forEach(ch=>{
    ch.classList.toggle('active', ch.dataset.scope===state.shop.scope);
    ch.onclick=()=>{ state.shop.scope=ch.dataset.scope; save(); initScopeChips(); renderShop(); };
  });
}
function getMealsByScope(){
  const today=new Date().toISOString().slice(0,10);
  if(state.shop.scope==='day') return (state.planWeeks.find(d=>d.date===today)||{meals:state.plan.meals}).meals||[];
  if(state.shop.scope==='week'){
    const idx=state.planWeeks.findIndex(d=>d.date===today);
    const slice=state.planWeeks.slice(Math.max(0,idx), Math.max(0,idx)+7);
    return slice.flatMap(d=>d.meals);
  }
  return state.planWeeks.flatMap(d=>d.meals); // 4w
}
function renderShop(){
  if(!state.plan.meals.length){ document.getElementById('shopList').innerHTML='<p class="muted">G√©n√®re un plan pour cr√©er la liste.</p>'; return; }
  const meals=getMealsByScope(); const list={};
  meals.forEach(m=>m.items.forEach(i=>{ list[i.food]=(list[i.food]||0)+i.grams; }));
  const st = state.shop;
  const el=document.getElementById('shopList');
  el.innerHTML = `<table class="table">${
    Object.keys(list).map(food=>{
      const id=food.replace(/[^a-z0-9]/gi,'_');
      const checked = (st.checked[id]||false)?'checked':'';
      const unit=(FOODS[food]&&FOODS[food].displayUnit==='ml')?'ml':'g';
      return `<tr>
        <td><input type="checkbox" ${checked} onchange="state.shop.checked['${id}']=this.checked; save();"></td>
        <td>${food}</td>
        <td style="text-align:right">${Math.round(list[food])} ${unit}</td>
      </tr>`;
    }).sort((a,b)=>a.localeCompare(b)).join('')
  }</table>`;
  renderCompare();
}
function useGPS(){
  if(!navigator.geolocation){ alert('G√©olocalisation non support√©e.'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    state.user.gps = {lat:pos.coords.latitude, lon:pos.coords.longitude};
    save(); refreshStores();
  }, _=>alert('Impossible d‚Äôobtenir la position.'));
}
function refreshStores(){
  const city = document.getElementById('cityInput').value || state.user.city || 'ville';
  state.user.city = city; save();
  const stores = [
    {name:'Discounter A', dist:'1.8 km'}, {name:'Super U', dist:'3.2 km'},
    {name:'Hypermarch√© X', dist:'6.5 km'}, {name:'Bio Coop', dist:'7.9 km'}, {name:'√âpicerie Y', dist:'0.9 km'}
  ];
  state.shop.stores = stores; save();
  document.getElementById('storeBox').innerHTML = stores.map(s=>`<div class="row" style="justify-content:space-between">
    <label class="row" style="gap:6px"><input type="checkbox" onchange="toggleStore('${s.name}', this.checked)"> ${s.name}</label>
    <span class="muted">${s.dist}</span>
  </div>`).join('');
  renderCompare();
}
function toggleStore(name, on){
  state.shop.prices[name] = state.shop.prices[name] || {};
  state.shop.prices[name].enabled = on; save(); renderCompare();
}
function renderCompare(){
  const box=document.getElementById('compareBox'); if(!box) return;
  const stores = Object.keys(state.shop.prices).filter(s=>state.shop.prices[s].enabled);
  if(!stores.length){ box.textContent='Active au moins un magasin (case √† cocher).'; return; }
  const meals=getMealsByScope(); const list={}; meals.forEach(m=>m.items.forEach(i=>{ list[i.food]=(list[i.food]||0)+i.grams; }));
  const rows = stores.map(s=>{
    const priceMap = state.shop.prices[s]||{};
    let total=0; Object.keys(list).forEach(food=>{
      const p = priceMap[food] || 0.01; total += p * list[food]; // 0.01‚Ç¨/g par d√©faut (maquette)
    });
    return {store:s, total:Math.round(total*100)/100};
  }).sort((a,b)=>a.total-b.total).slice(0,5);
  box.innerHTML = `<table class="table"><tr><td>Magasin</td><td style="text-align:right">Total estim√© (‚Ç¨)</td></tr>${
    rows.map(r=>`<tr><td>${r.store}</td><td style="text-align:right">${r.total.toFixed(2)}</td></tr>`).join('')
  }</table><p class="muted">Astuce : active des magasins puis enrichis leurs prix dans le JSON si tu veux un comparateur r√©el.</p>`;
}

/* Export / Import */
function exportState(){
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='armor-vision-nutrition-v15.json'; a.click(); URL.revokeObjectURL(url);
}
function exportCSV(){
  const meals=getMealsByScope(); const list={}; meals.forEach(m=>m.items.forEach(i=>{ list[i.food]=(list[i.food]||0)+i.grams; }));
  let csv='Aliment;Quantit√©;Unit√©\n'; Object.keys(list).forEach(k=>{
    const unit=(FOODS[k]&&FOODS[k].displayUnit==='ml')?'ml':'g'; csv+=`${k};${Math.round(list[k])};${unit}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='courses.csv'; a.click(); URL.revokeObjectURL(url);
}
function importJSON(ev){
  const f=ev.target.files[0]; if(!f) return; const fr=new FileReader();
  fr.onload=()=>{ try{ const s=JSON.parse(fr.result); localStorage.setItem('av-nutri-v15', JSON.stringify(s)); location.reload(); }catch(e){ alert('JSON invalide'); } };
  fr.readAsText(f);
}
/* Swipe & clavier pour naviguer entre sections */
(function(){
  const viewsOrder = ['dash','plan','shop','measures','settings'];
  let currentView = 'dash';
  let startX=null, startY=null;

  const _setView = window.setView;
  window.setView = function(id){ _setView(id); currentView = id; };

  const modalOpen = ()=> !!document.querySelector('.modal.show');
  const goNext = ()=> { const i = viewsOrder.indexOf(currentView); if(i>=0 && i<viewsOrder.length-1) setView(viewsOrder[i+1]); };
  const goPrev = ()=> { const i = viewsOrder.indexOf(currentView); if(i>0) setView(viewsOrder[i-1]); };

  const SURFACE = document.querySelector('main');
  const EDGE_GUARD = 30, DIST_MIN = 50, RATIO_HV = 1.2;

  SURFACE.addEventListener('touchstart', (e)=>{
    if(modalOpen()) return;
    const t = e.touches[0];
    if(t.clientX < EDGE_GUARD || t.clientX > window.innerWidth-EDGE_GUARD) return;
    startX = t.clientX; startY = t.clientY;
  }, {passive:true});

  SURFACE.addEventListener('touchend', (e)=>{
    if(startX===null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX, dy = t.clientY - startY;
    startX=null; startY=null;
    if(Math.abs(dx) < DIST_MIN || Math.abs(dx) < Math.abs(dy)*RATIO_HV) return;
    if(dx < 0) goNext(); else goPrev();
  }, {passive:true});

  document.addEventListener('keydown', (e)=>{
    if(modalOpen()) return;
    if(e.key==='ArrowRight') goNext();
    else if(e.key==='ArrowLeft') goPrev();
  });

  let wheelAccum = 0;
  SURFACE.addEventListener('wheel', (e)=>{
    if(modalOpen()) return;
    if(Math.abs(e.deltaX) <= Math.abs(e.deltaY)) return;
    wheelAccum += e.deltaX;
    if(Math.abs(wheelAccum) > 120){ wheelAccum>0 ? goNext() : goPrev(); wheelAccum = 0; }
  }, {passive:true});
})();

/* Init final */
window.addEventListener('load',()=>{
  updateProgLabel();
  updateBellUI();
});
</script>
<script>
window.addEventListener('load', ()=>{
  try {
    if (typeof injectTip === 'function') injectTip();           // astuce du jour centr√©e
    if (typeof injectNotifCard === 'function') injectNotifCard(); // notifications horaires / minutes avant
    if (typeof injectShopUI === 'function') injectShopUI();       // magasins OSM r√©els + comparateur
  } catch(e){ console.warn('v1.9 init patch', e); }
});
</script>
<script src="./av_v19.js"></script>
</body>
</html>
