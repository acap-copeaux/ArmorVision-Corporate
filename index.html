<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ArmorVision Nutrition</title>

<!-- Ajout PWA v1.9 -->
<link rel="manifest" href="./manifest.json">

<style>
:root{
  --bg:#0d1117; --fg:#e6edf3; --muted:#9ba3af; --panel:#111623; --border:#263043;
  --accent:#00c2ff; --accent2:#ff9a00; --good:#36d399; --warn:#fbbf24; --bad:#ef4444;
}
body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";}
a{color:var(--accent);text-decoration:none}
.muted{color:var(--muted)}
.page{display:none;padding:16px 16px 72px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 30px rgba(0,0,0,.25)}
.row{display:flex;align-items:center}
.seg{display:flex;gap:6px;flex-wrap:wrap}
.chip{border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer}
.chip.active{background:var(--accent);border-color:transparent;color:#0b1220}
.btn{border:1px solid var(--border);background:#0f1522;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.small{padding:6px 10px}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b1220;border:none}
.input{background:#0f1522;border:1px solid var(--border);border-radius:10px;color:var(--fg);padding:8px 10px}
.table-compact{width:100%;border-collapse:collapse}
.table-compact th,.table-compact td{border-bottom:1px solid var(--border);padding:6px 8px;font-size:14px}
.hidden{display:none}

/* Navbar (v1.5 style) */
nav.nav{position:fixed;left:0;right:0;bottom:0;background:#0f1420;border-top:1px solid var(--border);display:flex;gap:6px;justify-content:space-around;padding:10px}
nav.nav .item{display:flex;flex-direction:column;align-items:center;color:var(--muted);cursor:pointer}
nav.nav .item.active{color:var(--accent)}

/* Modale g√©n√©rique */
.modal{position:fixed;inset:0;display:none}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
.modal .sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(720px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
.modal.show{display:block}
.close-x{position:absolute;right:12px;top:8px;cursor:pointer;opacity:.75}

/* KPI / Score */
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.kpi .box{background:#0f1522;border:1px solid var(--border);border-radius:14px;padding:12px;text-align:center}
.kpi .big{font-size:28px;font-weight:700}
.kpi .label{font-size:12px;color:var(--muted)}

/* Slider/touch */
main{height:100%;min-height:100vh;overflow:hidden}
</style>
</head>
<body>
<main>

<!-- Accueil / Dashboard -->
<section id="dash" class="page" style="display:block">
  <h2>Accueil</h2>
  <div class="kpi">
    <div class="box">
      <div id="kpiAdh" class="big">‚Äî</div>
      <div class="label">Score d‚Äôadh√©rence</div>
    </div>
    <div class="box">
      <div id="kpiIMC" class="big">‚Äî</div>
      <div class="label">IMC</div>
    </div>
    <div class="box">
      <div id="kpiStreak" class="big">0</div>
      <div class="label">Streak (jours)</div>
    </div>
  </div>

  <!-- v1.9 injectera ici l‚ÄôAstuce du jour (centr√©e) -->
</section>

<!-- Programmes / Repas (MTC yin/yang, etc.) -->
<section id="plan" class="page">
  <h2>Programme & repas</h2>
  <div id="planDays" class="card">
    <h3>Journ√©e type</h3>
    <div id="mealsList"></div>
  </div>

  <div class="card">
    <h3>Suivi d‚Äôadh√©rence</h3>
    <div id="adhList"></div>
    <p class="muted">Coche ce que tu as respect√© aujourd‚Äôhui pour faire monter le score.</p>
  </div>
</section>
<!-- Courses / Magasins -->
<section id="shop" class="page">
  <h2>Courses</h2>

  <div id="listBox" class="card">
    <h3>Liste du jour</h3>
    <div id="listContent" class="muted">Aucun aliment pour l‚Äôinstant.</div>
  </div>

  <!-- v1.9 injectera automatiquement :
       - Contr√¥les Ville/üìç + √©tendue (Jour/Semaine/4 semaines)
       - Bloc ‚ÄúMagasins √† proximit√©‚Äù
       - Bloc ‚ÄúComparateur‚Äù
       - Editeur de prix (modal) -->
</section>

<!-- Param√®tres -->
<section id="settings" class="page">
  <h2>Param√®tres</h2>

  <div class="card">
    <h3>Profil</h3>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <label>Sexe
        <select id="sex" class="input">
          <option>Homme</option>
          <option>Femme</option>
        </select>
      </label>
      <label>√Çge <input id="age" type="number" min="10" max="110" class="input" style="max-width:110px"></label>
      <label>Taille (cm) <input id="height" type="number" min="120" max="230" class="input" style="max-width:110px"></label>
      <label>Poids (kg) <input id="weight" type="number" min="35" max="250" class="input" style="max-width:110px"></label>
      <button class="btn small" id="btnIMC">Calculer IMC</button>
    </div>
  </div>

  <div class="card">
    <h3>Pr√©f√©rences & MTC</h3>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <label><input type="checkbox" id="pref-vege"> V√©g√©tarien</label>
      <label><input type="checkbox" id="pref-vegan"> V√©gan</label>
      <label><input type="checkbox" id="pref-halal"> Halal</label>
      <label><input type="checkbox" id="pref-kosher"> Casher</label>
      <label><input type="checkbox" id="intol-gluten"> Sans gluten</label>
      <label><input type="checkbox" id="intol-lactose"> Sans lactose</label>
    </div>
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
      <span class="muted">√âquilibres MTC / Yin-Yang appliqu√©s aux repas.</span>
    </div>
  </div>

  <!-- v1.9 injectera ici la carte "Notifications" -->
</section>

</main>

<!-- Navbar -->
<nav class="nav" id="nav">
  <div class="item active" data-target="dash">üè†<small>Accueil</small></div>
  <div class="item" data-target="plan">üìã<small>Programme</small></div>
  <div class="item" data-target="shop">üõí<small>Courses</small></div>
  <div class="item" data-target="settings">‚öôÔ∏è<small>Param√®tres</small></div>
</nav>
<script>
// ====== STATE & PERSISTENCE (v1.5) ======
const state = JSON.parse(localStorage.getItem('av_state')||'{}');
function save(){ localStorage.setItem('av_state', JSON.stringify(state)); }

// ====== NAV SLIDE / SWIPE ======
(function(){
  const viewsOrder = ['dash','plan','shop','settings'];
  let currentView = 'dash', startX=null, startY=null;

  function _setView(id){
    document.querySelectorAll('.page').forEach(p=>p.style.display='none');
    const el = document.getElementById(id); if(el) el.style.display='block';
    document.querySelectorAll('nav .item').forEach(i=> i.classList.toggle('active', i.dataset.target===id));
  }
  window.setView = function(id){ _setView(id); currentView = id; };

  const modalOpen = ()=> !!document.querySelector('.modal.show');
  const goNext = ()=> { const i = viewsOrder.indexOf(currentView); if(i>=0 && i<viewsOrder.length-1) setView(viewsOrder[i+1]); };
  const goPrev = ()=> { const i = viewsOrder.indexOf(currentView); if(i>0) setView(viewsOrder[i-1]); };

  const SURFACE = document.querySelector('main');
  const EDGE_GUARD = 30, DIST_MIN = 50, RATIO_HV = 1.2;

  SURFACE.addEventListener('touchstart', (e)=>{
    if(modalOpen()) return;
    const t = e.touches[0];
    if(t.clientX < EDGE_GUARD || t.clientX > window.innerWidth-EDGE_GUARD) return;
    startX = t.clientX; startY = t.clientY;
  }, {passive:true});

  SURFACE.addEventListener('touchend', (e)=>{
    if(startX===null) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - startX, dy = t.clientY - startY;
    startX=null; startY=null;
    if(Math.abs(dx) < DIST_MIN || Math.abs(dx)/Math.max(1,Math.abs(dy))<RATIO_HV) return;
    if(dx<0) goNext(); else goPrev();
  }, {passive:true});

  document.querySelectorAll('nav .item').forEach(el=>{
    el.addEventListener('click', ()=> setView(el.dataset.target));
  });

  _setView(currentView);
})();
</script>

<script>
// ====== KPI / IMC / ADHERENCE (v1.5) ======
function updateIMC(){
  const h = parseFloat(document.getElementById('height').value||state.height||0)/100;
  const w = parseFloat(document.getElementById('weight').value||state.weight||0);
  if(!h||!w){ document.getElementById('kpiIMC').textContent='‚Äî'; return; }
  const imc = w/(h*h);
  document.getElementById('kpiIMC').textContent = imc.toFixed(1);
  state.imc = imc; save();
}
document.getElementById('btnIMC').addEventListener('click', updateIMC);

function renderMeals(){
  const meals = state.plan?.meals || [
    {time:'08:00', name:'Petit-d√©jeuner', mtc:'yin', items:[{food:'Flocons d‚Äôavoine', grams:60},{food:'Skyr nature', grams:150},{food:'Pomme', grams:150}]},
    {time:'12:30', name:'D√©jeuner', mtc:'yang', items:[{food:'Riz complet', grams:130},{food:'Poulet', grams:150},{food:'Brocoli', grams:200}]},
    {time:'19:00', name:'D√Æner', mtc:'yin', items:[{food:'Quinoa', grams:120},{food:'Saumon', grams:160},{food:'Haricots verts', grams:200}]},
  ];
  state.plan = state.plan || {}; state.plan.meals = meals; save();

  const box = document.getElementById('mealsList');
  box.innerHTML = meals.map(m=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><b>${m.time}</b> ‚Äî ${m.name} <span class="muted">MTC: ${m.mtc}</span></div>
      </div>
      <ul>${(m.items||[]).map(i=>`<li>${i.food} ‚Äî ${i.grams} g</li>`).join('')}</ul>
    </div>`).join('');
}

function renderAdh(){
  const meals = state.plan?.meals||[];
  const today = (new Date()).toISOString().slice(0,10);
  state.adh = state.adh || {};
  const day = state.adh[today] || {};
  const box = document.getElementById('adhList');
  box.innerHTML = meals.map((m,idx)=>`
    <label class="row" style="gap:8px;margin:6px 0">
      <input type="checkbox" data-idx="${idx}" ${day[idx]?'checked':''}>
      ${m.time} ‚Äî ${m.name}
    </label>`).join('');

  box.querySelectorAll('input[type=checkbox]').forEach(ch=>{
    ch.addEventListener('change', ()=>{
      const i = ch.dataset.idx;
      state.adh[today] = state.adh[today] || {};
      state.adh[today][i] = ch.checked;
      save(); updateKPI();
    });
  });
}

function updateKPI(){
  const today = (new Date()).toISOString().slice(0,10);
  const meals = state.plan?.meals||[];
  const done = Object.values(state.adh?.[today]||{}).filter(Boolean).length;
  const score = meals.length? Math.round(done/meals.length*100):0;
  document.getElementById('kpiAdh').textContent = meals.length? score+'%' : '‚Äî';

  // streak (compte les jours cons√©cutifs avec score >= 60%)
  let s=0; const dates=Object.keys(state.adh||{}).sort().reverse();
  for(const d of dates){
    const ms = state.plan?.meals?.length||3;
    const dn = Object.values(state.adh?.[d]||{}).filter(Boolean).length;
    if(ms && Math.round(dn/ms*100)>=60) s++; else break;
  }
  document.getElementById('kpiStreak').textContent = s;
}
</script>
<script>
// ====== COURSES LIST (v1.5-like) ======
function buildListFromMeals(){
  const meals = state.plan?.meals||[];
  const need = {};
  meals.forEach(m=> (m.items||[]).forEach(i=> need[i.food]=(need[i.food]||0)+i.grams ));
  const list = Object.entries(need);
  const box = document.getElementById('listContent');
  if(!list.length){ box.textContent='Aucun aliment pour l‚Äôinstant.'; return; }
  box.innerHTML = '<table class="table-compact"><tr><th>Aliment</th><th style="text-align:right">Quantit√©</th></tr>' +
    list.map(([k,g])=>`<tr><td>${k}</td><td style="text-align:right">${g} g</td></tr>`).join('') + '</table>';
}

// ====== INIT v1.5 ======
window.addEventListener('load', ()=>{
  try {
    renderMeals();
    renderAdh();
    updateKPI();
    buildListFromMeals();
  } catch(e){ console.warn('init v1.5', e); }
});
</script>

<!-- ====== INIT v1.9 : injections patch ====== -->
<script>
window.addEventListener('load', ()=>{
  try {
    if (typeof injectTip === 'function') injectTip();
    if (typeof injectNotifCard === 'function') injectNotifCard();
    if (typeof injectShopUI === 'function') injectShopUI();
  } catch(e){ console.warn('v1.9 init patch', e); }
});
</script>
<!-- ====== Service Worker (optionnel) ====== -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js', {scope:'./'}).catch(()=>{});
  });
}
</script>

<!-- ====== PATCH v1.9 (magasins, comparateur, notifications, astuce) ====== -->
<script src="./av_v19.js"></script>
</body>
</html>
